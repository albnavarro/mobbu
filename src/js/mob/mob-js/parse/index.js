import {
    MAIN_STORE_PARSER_ASYNC,
    PARSER_ASYNC_DEFAULT,
} from '../main-store/constant';
import { mainStore } from '../main-store/main-store';
import { parseComponentsWhile } from './parse-function-while';
import { resetCurrentIterationCounter } from './utils';

/**
 * @param {object} obj
 * @param {HTMLElement} obj.element
 * @param {boolean} [obj.persistent]
 * @param {string} [obj.parentIdForced]
 * @param {string} [obj.source]
 * @returns {Promise<void>} A promise to the token.
 */
export const parseComponents = async ({
    element,
    persistent = false,
    parentIdForced = '',
    source = PARSER_ASYNC_DEFAULT,
}) => {
    await parseComponentsWhile({
        element,
        persistent,
        parentIdForced,
        source,
    });

    resetCurrentIterationCounter();
};

/**
 * Parse component from inner component generated by first parseComponent. Use pub/sub to avoid circular dependencies.
 *
 * @returns {void}
 */
export const initParseWatcher = () => {
    mainStore.watch(
        MAIN_STORE_PARSER_ASYNC,
        async ({
            element,
            parentId,
            persistent = false,
            source = PARSER_ASYNC_DEFAULT,
        }) => {
            await parseComponents({
                element,
                parentIdForced: parentId ?? '',
                persistent,
                source,
            });
        }
    );
};

/**
 * @param {HTMLElement} element
 * @returns {Promise<void>} A promise to the token.
 */
export const parseDom = async (element) => {
    await parseComponents({
        element,
    });
};
